<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>足彩分析</title>

    <!-- Bootstrap core CSS -->
    <link href="dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="assets/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="assets/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <style>
        .fix-anchor { display: block; position: relative; top: -70px; visibility: hidden; }
    </style>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">足彩分析</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse pull-right">
          <ul class="nav navbar-nav">
            <li><button class="btn btn-primary btn-large" style="margin-top: 10px" onclick="submit()">提交分析</button></li>
            <li>&nbsp;</li>
            <li><button class="btn btn btn-large" style="margin-top: 10px" onclick="clearSelect()">清空筛选条件</button></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="placeholder" style="height: 70px"></div>

    <div class="container">
      <div class="row">
        <div class="col-md-2">
          <ul class="nav nav-pills nav-stacked" style="position: fixed">
              <li><a href="#europe">欧赔</a></li>
              <li><a href="#asia">亚盘</a></li>
              <li><a href="#recent10-credit">近 10 场积分</a></li>
              <li><a href="#recent10-goal">近 10 场进球数</a></li>
              <li><a href="#result">分析结果</a></li>
          </ul>
        </div>

        <div class="col-md-10">
          <div id="europe" class="fix-anchor"></div>
          <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">欧赔<span class="pull-right">（以终赔为准）</span></h3>
            </div>
            <div class="row">
              <div class="col-md-4">
                <div id="eu_host_win_e" style="height: 400px"></div>
                <div class="row">
                  <div class="col-md-2"></div>
                  <div class="col-md-3"><br>初<br>赔</div>
                  <div class="col-md-3">
                    <label for="eu_host_win_e_lt_s"><input id="eu_host_win_e_lt_s" type="checkbox" checked /> &lt;</label><br/>
                    <label for="eu_host_win_e_eq_s"><input id="eu_host_win_e_eq_s" type="checkbox" checked /> =</label><br/>
                    <label for="eu_host_win_e_gt_s"><input id="eu_host_win_e_gt_s" type="checkbox" checked /> &gt;</label>
                  </div> 
                  <div class="col-md-4"><br>终<br>赔</div>
                </div>
              </div>
              <div class="col-md-4">
                <div id="eu_draw_e" style="height: 400px"></div>
                <div class="row">
                  <div class="col-md-2"></div>
                  <div class="col-md-3"><br>初<br>赔</div>
                  <div class="col-md-3">
                    <label for="eu_draw_e_lt_s"><input id="eu_draw_e_lt_s" type="checkbox" checked /> &lt;</label><br/>
                    <label for="eu_draw_e_eq_s"><input id="eu_draw_e_eq_s" type="checkbox" checked /> =</label><br/>
                    <label for="eu_draw_e_gt_s"><input id="eu_draw_e_gt_s" type="checkbox" checked /> &gt;</label>
                  </div> 
                  <div class="col-md-4"><br>终<br>赔</div>
                </div>
              </div>
              <div class="col-md-4">
                <div id="eu_guest_win_e" style="height: 400px"></div>
                <div class="row">
                  <div class="col-md-2"></div>
                  <div class="col-md-3"><br>初<br>赔</div>
                  <div class="col-md-3">
                    <label for="eu_guest_win_e_lt_s"><input id="eu_guest_win_e_lt_s" type="checkbox" checked /> &lt;</label><br/>
                    <label for="eu_guest_win_e_eq_s"><input id="eu_guest_win_e_eq_s" type="checkbox" checked /> =</label><br/>
                    <label for="eu_guest_win_e_gt_s"><input id="eu_guest_win_e_gt_s" type="checkbox" checked /> &gt;</label>
                  </div> 
                  <div class="col-md-4"><br>终<br>赔</div>
                </div>
              </div>
            </div>
          </div>

          <div id="asia" class="fix-anchor"></div>
          <div class="panel panel-primary cond">
            <div class="panel-heading">
                <h3 class="panel-title">亚盘<span class="pull-right">（以终赔为准）</span></h3>
            </div>
            <div class="panel-body row">
              <div class="col-md-4">
                <div id="as_host_win_e" style="height: 400px"></div>
                <div class="row">
                  <div class="col-md-2"></div>
                  <div class="col-md-3"><br>初<br>赔</div>
                  <div class="col-md-3">
                    <label for="as_host_win_e_lt_s"><input id="as_host_win_e_lt_s" type="checkbox" checked /> &lt;</label><br/>
                    <label for="as_host_win_e_eq_s"><input id="as_host_win_e_eq_s" type="checkbox" checked /> =</label><br/>
                    <label for="as_host_win_e_gt_s"><input id="as_host_win_e_gt_s" type="checkbox" checked /> &gt;</label>
                  </div> 
                  <div class="col-md-4"><br>终<br>赔</div>
                </div>
              </div>
              <div class="col-md-4">
                <div id="as_dish_e" style="height: 400px"></div>
                <div class="row">
                  <div class="col-md-2"></div>
                  <div class="col-md-3"><br>初<br>赔</div>
                  <div class="col-md-3">
                      <label for="as_dish_e_lt_s"><input id="as_dish_e_lt_s" type="checkbox" checked /> &lt;</label><br/>
                      <label for="as_dish_e_eq_s"><input id="as_dish_e_eq_s" type="checkbox" checked /> =</label><br/>
                      <label for="as_dish_e_gt_s"><input id="as_dish_e_gt_s" type="checkbox" checked /> &gt;</label>
                  </div> 
                  <div class="col-md-4"><br>终<br>赔</div>
                </div>
              </div>
              <div class="col-md-4">
                <div id="as_guest_win_e" style="height: 400px"></div>
                <div class="row">
                  <div class="col-md-2"></div>
                  <div class="col-md-3"><br>初<br>赔</div>
                  <div class="col-md-3">
                      <label for="as_guest_win_e_lt_s"><input id="as_guest_win_e_lt_s" type="checkbox" checked /> &lt;</label><br/>
                      <label for="as_guest_win_e_eq_s"><input id="as_guest_win_e_eq_s" type="checkbox" checked /> =</label><br/>
                      <label for="as_guest_win_e_gt_s"><input id="as_guest_win_e_gt_s" type="checkbox" checked /> &gt;</label>
                  </div> 
                  <div class="col-md-4"><br>终<br>赔</div>
                </div>
              </div>
            </div>
          </div>  

          <div id="recent10-credit" class="fix-anchor"></div>
          <div class="panel panel-primary cond">
            <div class="panel-heading">
                <h3 class="panel-title">近 10 场积分<span class="pull-right">（已区分主客场）</span></h3>
            </div>
            <div class="panel-body row">
              <div class="col-md-6">
                <div id="recent10_host_credit" style="height: 400px"></div>
              </div>
              <div class="col-md-6">
                <div id="recent10_guest_credit" style="height: 400px"></div>
              </div>
            </div>
          </div>
            
          <div id="recent10-goal" class="fix-anchor"></div>
          <div class="panel panel-primary cond">
            <div class="panel-heading">
                <h3 class="panel-title">近 10 场进球数<span class="pull-right">（已区分主客场）</span></h3>
            </div>
            <div class="panel-body row">
              <div class="col-md-6">
                <div id="recent10_host_goal" style="height: 400px"></div>
              </div>
              <div class="col-md-6">
                <div id="recent10_host_lose" style="height: 400px"></div>
              </div>
              <div class="col-md-6">
                <div id="recent10_guest_goal" style="height: 400px"></div>
              </div>
              <div class="col-md-6">
                <div id="recent10_guest_lose" style="height: 400px"></div>
              </div>
            </div>
          </div>

          <p><button class="btn btn-large btn-primary" onclick="submit()">提交分析</button></p>

          <hr>

          <div id="result" class="fix-anchor"></div>
          <div>
            <h2>分析结果</h2>
            <div class="panel panel-info">
              <div class="panel-heading">
                <h3 class="panel-title">统计图</h3>
              </div>
              <div id="result-win-lose-graph">
                  <div id="result-hint" class="alert alert-warning" role="alert">
                      <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                      <span class="sr-only">Hint</span>
                      请选择合适的筛选条件，并点击 “提交分析” 按钮。
                  </div>
              </div>
              <div style="display:none">
                  <div id="result-nodata" class="alert alert-danger" role="alert">
                      <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                      <span class="sr-only">Error:</span>
                      抱歉，没有找到符合筛选条件的场次，请尝试修改筛选条件。
                  </div>
              </div>
            </div>

            <div class="panel panel-info">
              <div class="panel-heading">
                <h3 class="panel-title">详细数据</h3>
              </div>
              <div id="fulldata">
                <table class="table">
                  <thead>
                      <tr><th></th><th></th><th></th><th></th><th colspan="3">亚盘</th><th colspan="3">欧赔</th><th></th><th colspan="2">进球数</th></tr>
                      <tr><th>联赛</th><th>日期</th><th>主队</th><th>客队</th><th>水</th><th>盘口</th><th>水</th><th>胜</th><th>平</th><th>负</th><th>赛果</th><th>主</th><th>客</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>

                <nav>
                  <ul class="pager">
                    <li class="previous"><a onclick="showDataPrev()" style="cursor:pointer"><span aria-hidden="true">&larr;</span> 上一页</a></li>
                    <li class="next"><a onclick="showDataNext()" style="cursor:pointer">下一页 <span aria-hidden="true">&rarr;</span></a></li>
                  </ul>
                </nav>
              </div>
            </div>
          </div>

        </div>
      </div>
      <hr>

      <footer>
        <p>&copy; USTC 学术猫 2014</p>
      </footer>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="assets/js/ie10-viewport-bug-workaround.js"></script>

    <script src="highstock/js/highstock.js"></script>
    <script src="highstock/js/modules/exporting.js"></script>
  </body>
<script type="text/javascript">
function hideZoomBar(chart) {
    $.each(chart.rangeSelector.buttons, function () {
        this.hide();
    });
    $(chart.rangeSelector.divRelative).hide();
};

function LoadChart(column, title) {
    $.getJSON('/api/stats/' + column, function (data) {

        for (i in data) {
            data[i][0] = data[i][0] * 1000;
        }

        $('#' + column).highcharts('StockChart', {
            chart: {
                alignTicks: false
            },

            tooltip: {
                formatter: function() {
                    return '<b>' + (this.x / 1000.0) + '</b> (' + this.y + ' 场)';
                }
            },

            rangeSelector: {
                inputEnabled: 1,
                inputDateFormat: '%S.%L',
                inputEditDateFormat: '%S.%L',
                inputDateParser: function(value) {
                    return value * 1000;
                },
            },

            title: {
                text: title,
            },

            series: [{
                type: 'column',
                name: '场数',
                data: data,
            }],

            xAxis: {
                labels: {
                    maxStaggerLines: 1,
                    formatter: function () {
                        return this.value / 1000.0;
                    }
                }
            },

            navigator: {
                xAxis: {
                    labels: {
                        formatter: function () {
                            return this.value / 1000.0;
                        }
                    }
                }
            },

            credits: {enabled: false},
        });
        
        hideZoomBar($('#' + column).highcharts());
    });
}

function as_dish_to_string(n) {
    if (n % 500 == 0)
        return n / 1000.0;
    else {
        var negative = false;
        if (n < 0) {
            negative = true;
            n = -n;
        }
        var real = (n - n % 500) / 1000.0;
        var img = '';
        n = n % 500;
        if (n / 10.0 < real + 5) // eliminate too large dishes
            img = '/' + (n / 10.0);
        return (negative ? '-' : '') + real + img;
    }
}

function LoadDishChart(column, title) {
    $.getJSON('/api/stats/' + column, function (data) {

        for (i in data) {
            data[i][0] = data[i][0] * 1000;
        }

        $('#' + column).highcharts('StockChart', {
            chart: {
                alignTicks: false
            },

            tooltip: {
                formatter: function() {
                    return '<b>' + (as_dish_to_string(this.x / 1000.0)) + '</b> (' + this.y + ' 场)';
                }
            },

            rangeSelector: {
                enabled: false,
            },

            title: {
                text: title,
            },

            series: [{
                type: 'column',
                name: '场数',
                data: data,
            }],

            xAxis: {
                labels: {
                    maxStaggerLines: 1,
                    formatter: function () {
                        return as_dish_to_string(this.value / 1000.0);
                    }
                }
            },

            navigator: {
                xAxis: {
                    labels: {
                        formatter: function () {
                            return as_dish_to_string(this.value / 1000.0);
                        }
                    }
                }
            },

            credits: {enabled: false},
        });
        
        hideZoomBar($('#' + column).highcharts());
    });
}

$(function () {
    LoadChart('eu_host_win_e', '胜');
    LoadChart('eu_draw_e', '平');
    LoadChart('eu_guest_win_e', '负');
    LoadChart('as_host_win_e', '水');
    LoadDishChart('as_dish_e', '盘口');
    LoadChart('as_guest_win_e', '水');
    LoadChart('recent10_host_credit', '主队积分');
    LoadChart('recent10_guest_credit', '客队积分');
    LoadChart('recent10_host_goal', '主队进球数');
    LoadChart('recent10_host_lose', '主队失球数');
    LoadChart('recent10_guest_goal', '客队进球数');
    LoadChart('recent10_guest_lose', '客队失球数');
    clearSelect();
});

function ShowResult(data) {
    if (data[0] == 0 && data[1] == 0 && data[2] == 0) {
        $('#result-win-lose-graph').html($('#result-nodata').clone());
        return;
    }
    var chartData = [
        ['胜', data[0]],
        ['平', data[1]],
        ['负', data[2]],
    ];
    $('#result-win-lose-graph').highcharts({
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: 1,//null,
            plotShadow: false
        },
        title: {
            text: '胜平负场数统计'
        },
        plotOptions: {
            pie: {
                allowPointSelect: true,
                cursor: 'pointer',
                dataLabels: {
                    enabled: true,
                    format: '<b>{point.name}</b>: {point.y} ({point.percentage:.1f} %)',
                    style: {
                        color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                    }
                }
            }
        },
        series: [{
            type: 'pie',
            name: '场数',
            data: chartData,
        }],
        credits: {enabled: false},
    });
    $('#result').show();
    window.location = '#result';
}

var value_fields = [
        'eu_host_win_e',
        'eu_draw_e',
        'eu_guest_win_e',
        'as_host_win_e',
        'as_dish_e',
        'as_guest_win_e',
        'recent10_host_credit',
        'recent10_guest_credit',
        'recent10_host_goal',
        'recent10_host_lose',
        'recent10_guest_goal',
        'recent10_guest_lose',
    ];

var checkbox_fields = [
        'eu_host_win_e',
        'eu_draw_e',
        'eu_guest_win_e',
        'as_host_win_e',
        'as_dish_e',
        'as_guest_win_e',
    ];

function CollectData() {
    var data = {};
    for (var i in value_fields) {
        var name = value_fields[i];
        if (typeof $('#' + name).highcharts() == "object") {
            data[name + '_min'] = $('#' + name).highcharts().xAxis[0].min;
            data[name + '_max'] = $('#' + name).highcharts().xAxis[0].max;
        }
    }
    for (var i in checkbox_fields) {
        var name = checkbox_fields[i];
        var suffixes = ['_lt_s', '_eq_s', '_gt_s'];
        for (var j in suffixes) {
            var suffix = suffixes[j];
            if (typeof $('#' + name + suffix) == "object") {
                data[name + suffix] = $('#' + name + suffix).prop('checked');
            }
        }
    }
    return data;
}

function ShowFullData(data_arr) {
    noMoreData = (data_arr.length == 0);
    var html = '';
    for (var i in data_arr) {
        var data = data_arr[i];
        html += '<tr>'
            + '<td>' + data.type + '</td>'
            + '<td>' + data.date.split('T')[0] + '</td>'
            + '<td>' + data.host_team + '</td>'
            + '<td>' + data.guest_team + '</td>'
            + '<td>' + data.as_host_win_e + '</td>'
            + '<td>' + data.as_dish_e + '</td>'
            + '<td>' + data.as_guest_win_e + '</td>'
            + '<td>' + data.eu_host_win_e + '</td>'
            + '<td>' + data.eu_draw_e + '</td>'
            + '<td>' + data.eu_guest_win_e + '</td>'
            + '<td>' + (data.result == 1 ? '主胜' : (data.result == 0 ? '平' : '客胜')) + '</td>'
            + '<td>' + data.score_host + '</td>'
            + '<td>' + data.score_guest + '</td>'
            + '</tr>';
    }
    $('#fulldata table tbody').html(html);
}

var select_cond = null;
var noMoreData = false;
var dataEntriesPerPage = 10;
function showDataPrev() {
    if (select_cond && select_cond.limit_start >= dataEntriesPerPage) {
        select_cond.limit_start -= dataEntriesPerPage;
        loadAndShowData(select_cond);
    }
}

function showDataNext() {
    if (select_cond && !noMoreData) {
        select_cond.limit_start += dataEntriesPerPage;
        loadAndShowData(select_cond);
    }
}

function loadAndShowData(data) {
    $.ajax({
        type: "POST",
        url: '/api/analysis/showData',
        data: JSON.stringify(data),
        success: ShowFullData,
        dataType: "json",
    });
}

function submit() {
    var data = CollectData();
    console.log(data);
    $.ajax({
        type: "POST",
        url: '/api/analysis/stats',
        data: JSON.stringify(data),
        success: ShowResult,
        dataType: "json",
    });

    data.limit_start = 0;
    data.limit_num = dataEntriesPerPage;
    loadAndShowData(data);
    select_cond = data;
}

function clearSelect() {
    for (var i in value_fields) {
        var name = value_fields[i];
        if (typeof $('#' + name).highcharts() == "object") {
            var obj = $('#' + name).highcharts().xAxis[0];
            obj.setExtremes(obj.dataMin, obj.dataMax);
        }
    }
    for (var i in checkbox_fields) {
        var name = checkbox_fields[i];
        var suffixes = ['_lt_s', '_eq_s', '_gt_s'];
        for (var j in suffixes) {
            var suffix = suffixes[j];
            if (typeof $('#' + name + suffix) == "object") {
                $('#' + name + suffix).prop('checked', true);
            }
        }
    }
}
</script>
</html>
